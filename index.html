<!DOCTYPE html>
<html lang="ms">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Laporan Lawatan Tapak ‚Äî Mobile</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- jsPDF (pilihan). Jika tiada internet/CDN disekat, fallback ke cetak HTML -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
      :root {
        --bg: #0b1220;
        --card: #121a2b;
        --text: #e7eefc;
        --muted: #8aa0c6;
        --accent: #4f8cff;
        --ok: #17d19b;
        --warn: #ffcc66;
        --danger: #ff647c;
        --border: #1d2942;
      }
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      html,
      body {
        height: 100%;
        touch-action: manipulation;
        -webkit-text-size-adjust: 100%;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }
      
      /* Allow text selection for inputs and textareas */
      input, textarea, [contenteditable] {
        -webkit-user-select: text;
        user-select: text;
        -webkit-touch-callout: default;
      }
      
      button,
      a,
      input,
      textarea {
        touch-action: manipulation;
      }
      body {
        margin: 0;
        font-family: Inter, system-ui, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        -webkit-text-size-adjust: 100%;
        position: relative;
        overflow-x: hidden;
      }
      .wrap {
        max-width: 860px;
        margin-inline: auto;
        padding: 16px;
        min-height: 100vh;
      }
      h1 {
        font-size: 1.35rem;
        margin: 0 0 8px;
      }
      .subtitle {
        color: var(--muted);
        font-size: 0.9rem;
        margin-bottom: 16px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
        margin: 12px 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      }
      .row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      @media (min-width: 560px) {
        .row.cols-2 {
          grid-template-columns: 1fr 1fr;
        }
      }
      label {
        font-size: 0.85rem;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 12px;
        background: #0c1529;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 16px;
        line-height: 1.4;
        -webkit-appearance: none;
        appearance: none;
      }
      input[type="date"] {
        padding: 10px 12px;
      }
      textarea {
        min-height: 88px;
        resize: vertical;
      }
      .btnbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      button {
        appearance: none;
        -webkit-appearance: none;
        border: 1px solid var(--border);
        background: #0f1a31;
        color: var(--text);
        padding: 10px 14px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        font-size: 16px; /* Prevent zoom on iOS */
        min-height: 44px; /* iOS touch target */
        -webkit-tap-highlight-color: transparent;
      }
      button.primary {
        background: var(--accent);
        border-color: transparent;
        color: #fff;
      }
      button.ok {
        background: var(--ok);
        border-color: transparent;
        color: #051b11;
      }
      button.warn {
        background: var(--warn);
        border-color: transparent;
        color: #111;
      }
      button.danger {
        background: var(--danger);
        border-color: transparent;
        color: #fff;
      }
      .thumb {
        display: block;
        width: 100%;
        max-height: 220px;
        object-fit: contain;
        background: #0c1529;
        border: 1px dashed var(--border);
        border-radius: 12px;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
        table-layout: fixed; /* Better mobile performance */
      }
      .table th,
      .table td {
        border: 1px solid var(--border);
        padding: 10px;
        vertical-align: top;
        word-wrap: break-word;
      }
      .table th {
        background: #0f1a31;
        position: sticky;
        top: 0;
      }
      
      /* Mobile optimized table */
      @media (max-width: 767px) {
        .table {
          font-size: 0.8rem;
        }
        .table th,
        .table td {
          padding: 8px 4px;
        }
        .table th:first-child,
        .table td:first-child {
          width: 30%;
        }
        .table th:nth-child(2),
        .table td:nth-child(2) {
          width: 20%;
        }
        .table th:nth-child(3),
        .table td:nth-child(3) {
          width: 40%;
        }
        .table th:last-child,
        .table td:last-child {
          width: 10%;
        }
      }
      
      .tmuted {
        color: var(--muted);
      }
      .toast {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 20px;
        background: #091021;
        color: #fff;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid var(--border);
        display: none;
        z-index: 1000;
        max-width: 90vw;
        text-align: center;
      }
      
      .btn-ghost {
        background: transparent;
        font-size: 0.8rem;
        padding: 6px 10px;
        min-height: 32px;
      }
      .note {
        font-size: 0.8rem;
        color: var(--muted);
        margin-top: 12px;
      }
      
      /* Fix iOS double-tap zoom */
      .no-zoom {
        touch-action: manipulation;
      }
      
      /* Prevent horizontal scroll */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Image in table optimizations */
      .table img {
        max-width: 100%;
        max-height: 120px;
        object-fit: cover;
        border-radius: 6px;
        display: block;
        margin: 0 auto;
      }
      
      @media print {
        #section4,
        .toast {
          display: none !important;
        }
        body {
          background: #fff;
          color: #000;
        }
      }
      
      /* Loading state */
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }
      
      /* Better focus states for iOS */
      input:focus,
      textarea:focus,
      button:focus {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
      }
    </style>
  </head>
  <body class="no-zoom">
    <div class="wrap">
      <h1>üìã Laporan Lawatan Tapak</h1>
      <div class="subtitle">
        Borang mudah alih untuk laporan lawatan tapak. Data akan disimpan secara
        tempatan.
      </div>

      <!-- SECTION 1 -->
      <div class="card" id="section1">
        <h2>Maklumat Asas</h2>
        <div class="row cols-2">
          <div>
            <label>Nama Projek *</label>
            <input
              id="namaProjek"
              placeholder="cth: Naik Taraf IP PBX Bangunan A"
              required
            />
          </div>
          <div>
            <label>Perkara *</label>
            <input
              id="perkara"
              placeholder="cth: Khidmat Nasihat Cadangan Penggantian PABX ..."
              required
            />
          </div>
          <div>
            <label>Tarikh *</label>
            <input id="tarikh" type="date" required />
          </div>
          <div>
            <label>Nama Bangunan</label>
            <input
              id="namaBangunan"
              placeholder="cth: Blok Utara, TC4 Tingkat 8"
            />
          </div>
          <div>
            <label>Email *</label>
            <input
              id="email"
              type="email"
              placeholder="cth: nama@agensi.gov.my"
              required
            />
          </div>
        </div>
        <p class="note">
          Medan bertanda * adalah wajib. Data akan disimpan secara automatik.
        </p>
      </div>

      <!-- SECTION 2 (Item input) -->
      <div class="card" id="section2">
        <h2>Butiran Lokasi</h2>
        <div class="row">
          <div>
            <label>Nama bilik / lokasi</label>
            <input id="lokasi" placeholder="cth: Bilik TCR 1" />
          </div>

          <div>
            <label>Gambar (pilih Kamera atau Galeri)</label>
            <div class="btnbar">
              <input
                id="fileCamera"
                type="file"
                accept="image/*"
                capture="environment"
                hidden
                multiple
              />
              <input id="fileGallery" type="file" accept="image/*" hidden multiple />
              <button id="btnKamera" class="primary">üì∑ Kamera</button>
              <button id="btnGaleri" class="primary">üñºÔ∏è Galeri</button>
            </div>
            <div id="previewContainer" style="display: none; margin-top: 8px">
              <div id="imagePreview"></div>
              <button id="btnClearImages" class="btn-ghost" style="margin-top: 8px">Kosongkan Gambar</button>
            </div>
          </div>

          <div>
            <label>Ulasan (bullet atau baris baharu)</label>
            <textarea
              id="ulasan"
              placeholder="‚Ä¢ Kabel network UTP 6A...&#10;‚Ä¢ Tray fiber rapi..."
            ></textarea>
          </div>
        </div>

        <div class="btnbar" style="margin-top: 8px">
          <button class="ok" id="btnSimpanData">Simpan Item</button>
          <button class="warn" id="btnClear">Set Semula</button>
        </div>
      </div>

      <!-- SECTION 3 (list) -->
      <div class="card" id="section3">
        <h2>Senarai Item Disimpan</h2>
        <div class="table-container">
          <table class="table" id="entriesTable">
            <thead>
              <tr>
                <th>Gambar</th>
                <th>Lokasi</th>
                <th>Ulasan</th>
                <th>Tindakan</th>
              </tr>
            </thead>
            <tbody id="entriesBody">
              <tr>
                <td class="tmuted" colspan="4">Tiada data.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- SECTION 4 (only Simpan & Hantar) -->
      <div class="card" id="section4">
        <div class="btnbar">
          <button id="btnSubmit" class="danger">Simpan & Hantar</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">Berjaya disimpan.</div>

    <script>
      // ===== Util asas
      const $ = (id) => document.getElementById(id);
      const showToast = (msg) => {
        const t = $("toast");
        t.textContent = msg;
        t.style.display = "block";
        setTimeout(() => (t.style.display = "none"), 2000);
      };
      const todayISO = () => new Date().toISOString().slice(0, 10);
      const LS_KEYS = {
        form: "laporan_form_v4",
        entries: "laporan_entries_v4",
      };

      // ===== Prevent iOS zoom issues
      document.addEventListener('touchstart', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });

      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(e) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, { passive: false });

      // ===== Autosave form
      const formEls = {
        namaProjek: $("namaProjek"),
        perkara: $("perkara"),
        tarikh: $("tarikh"),
        namaBangunan: $("namaBangunan"),
        email: $("email"),
      };
      const loadForm = () => {
        try {
          const d = JSON.parse(localStorage.getItem(LS_KEYS.form) || "{}");
          Object.entries(formEls).forEach(([k, el]) => {
            if (d[k]) el.value = d[k];
          });
          if (!formEls.tarikh.value) formEls.tarikh.value = todayISO();
        } catch (e) {}
      };
      const saveForm = () => {
        const d = {};
        Object.entries(formEls).forEach(([k, el]) => (d[k] = el.value.trim()));
        localStorage.setItem(LS_KEYS.form, JSON.stringify(d));
      };
      Object.values(formEls).forEach((el) =>
        el.addEventListener("input", saveForm)
      );

      // ===== Enhanced image handling for multiple images
      const MAX_WIDTH = 1200;
      const state = { images: [] };
      
      const fileToDataURL = (file) =>
        new Promise((resolve, reject) => {
          const img = new Image();
          const fr = new FileReader();
          fr.onload = () => {
            img.onload = () => {
              const scale = Math.min(
                1,
                MAX_WIDTH / (img.naturalWidth || MAX_WIDTH)
              );
              const w = Math.round((img.naturalWidth || MAX_WIDTH) * scale),
                h = Math.round((img.naturalHeight || MAX_WIDTH * 0.66) * scale);
              const cv = document.createElement("canvas");
              cv.width = w;
              cv.height = h;
              cv.getContext("2d").drawImage(img, 0, 0, w, h);
              resolve(cv.toDataURL("image/jpeg", 0.85));
            };
            img.onerror = reject;
            img.src = fr.result;
          };
          fr.onerror = reject;
          fr.readAsDataURL(file);
        });

      const updateImagePreview = () => {
        const container = $("previewContainer");
        const preview = $("imagePreview");
        
        if (state.images.length === 0) {
          container.style.display = "none";
          return;
        }
        
        container.style.display = "block";
        preview.innerHTML = "";
        
        state.images.forEach((imgData, index) => {
          const imgWrapper = document.createElement("div");
          imgWrapper.style.cssText = `
            position: relative;
            display: inline-block;
            margin: 4px;
            border-radius: 8px;
            overflow: hidden;
          `;
          
          const img = document.createElement("img");
          img.src = imgData;
          img.style.cssText = `
            max-width: 120px;
            max-height: 120px;
            object-fit: cover;
            border-radius: 8px;
            display: block;
          `;
          
          const removeBtn = document.createElement("button");
          removeBtn.textContent = "√ó";
          removeBtn.style.cssText = `
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 100, 124, 0.9);
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: auto;
            padding: 0;
          `;
          
          removeBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            state.images.splice(index, 1);
            updateImagePreview();
            showToast("Gambar dipadamkan");
          };
          
          imgWrapper.appendChild(img);
          imgWrapper.appendChild(removeBtn);
          preview.appendChild(imgWrapper);
        });
      };

      $("btnKamera").addEventListener("click", (e) => {
        e.preventDefault();
        $("fileCamera").click();
      });
      
      $("btnGaleri").addEventListener("click", (e) => {
        e.preventDefault();
        $("fileGallery").click();
      });

      async function onFilesPicked(files) {
        if (!files || files.length === 0) return;
        
        const loadingToast = showToast("Memproses gambar...");
        
        try {
          for (const file of Array.from(files)) {
            if (state.images.length >= 10) {
              showToast("Maksimum 10 gambar sahaja");
              break;
            }
            
            const url = await fileToDataURL(file);
            state.images.push(url);
          }
          
          updateImagePreview();
          showToast(`${files.length} gambar ditambah`);
          
        } catch (e) {
          console.error(e);
          showToast("Gagal memproses gambar");
        }
      }

      $("fileCamera").addEventListener("change", (e) => {
        onFilesPicked(e.target.files);
        e.target.value = ""; // Reset untuk membolehkan pilihan berulang
      });
      
      $("fileGallery").addEventListener("change", (e) => {
        onFilesPicked(e.target.files);
        e.target.value = ""; // Reset untuk membolehkan pilihan berulang
      });

      $("btnClearImages").addEventListener("click", (e) => {
        e.preventDefault();
        state.images = [];
        updateImagePreview();
        showToast("Semua gambar dikosongkan");
      });

      // ===== Entries (lokasi, ulasan, img)
      const readEntries = () => {
        try {
          return JSON.parse(localStorage.getItem(LS_KEYS.entries) || "[]");
        } catch (e) {
          return [];
        }
      };
      const writeEntries = (arr) =>
        localStorage.setItem(LS_KEYS.entries, JSON.stringify(arr));
        
      const refreshTable = () => {
        const body = $("entriesBody");
        body.innerHTML = "";
        const items = readEntries();
        if (items.length === 0) {
          body.innerHTML =
            '<tr><td class="tmuted" colspan="4">Tiada data.</td></tr>';
          return;
        }
        items.forEach((it, idx) => {
          const tr = document.createElement("tr");
          const tImg = document.createElement("td");
          
          // Handle multiple images
          if (it.images && it.images.length > 0) {
            const imgContainer = document.createElement("div");
            it.images.forEach((imgSrc, imgIdx) => {
              const img = document.createElement("img");
              img.src = imgSrc;
              img.style.cssText = "max-width: 80px; max-height: 80px; object-fit: cover; margin: 2px; border-radius: 4px; display: inline-block;";
              imgContainer.appendChild(img);
            });
            tImg.appendChild(imgContainer);
          } else if (it.img) {
            // Backward compatibility for single image
            const img = document.createElement("img");
            img.src = it.img;
            img.style.cssText = "max-width: 100%; max-height: 120px; object-fit: cover; border-radius: 6px;";
            tImg.appendChild(img);
          } else {
            tImg.innerHTML = '<span class="tmuted">(tiada)</span>';
          }
          
          const tLok = document.createElement("td");
          tLok.textContent = it.lokasi || "";
          const tUlas = document.createElement("td");
          tUlas.innerHTML = (it.ulasan || "").replace(/\n/g, "<br>");
          const tAct = document.createElement("td");
          const del = document.createElement("button");
          del.className = "btn-ghost";
          del.textContent = "Padam";
          del.onclick = () => {
            if (confirm("Padam item ini?")) {
              const a = readEntries();
              a.splice(idx, 1);
              writeEntries(a);
              refreshTable();
              showToast("Item dipadamkan");
            }
          };
          tAct.appendChild(del);
          tr.append(tImg, tLok, tUlas, tAct);
          body.appendChild(tr);
        });
      };

      $("btnSimpanData").addEventListener("click", () => {
        const lokasi = $("lokasi").value.trim();
        const ulasan = $("ulasan").value.trim();
        const images = [...state.images]; // Copy current images
        
        if (!lokasi && !ulasan && images.length === 0) {
          showToast("Tiada apa untuk disimpan");
          return;
        }
        
        const arr = readEntries();
        const newItem = { 
          lokasi, 
          ulasan, 
          images, // Store multiple images
          ts: Date.now() 
        };
        
        // Keep backward compatibility
        if (images.length > 0) {
          newItem.img = images[0]; // First image for compatibility
        }
        
        arr.push(newItem);
        writeEntries(arr);
        refreshTable();
        showToast("Item ditambah");

        // Reset form - clear lokasi and ulasan but keep images for next entry
        $("lokasi").value = "";
        $("ulasan").value = "";
      });

      $("btnClear").addEventListener("click", () => {
        $("lokasi").value = "";
        $("ulasan").value = "";
        state.images = [];
        updateImagePreview();
        $("fileCamera").value = "";
        $("fileGallery").value = "";
        showToast("Borang dikosongkan");
      });

      // ===== PDF builder (updated for multiple images)
      async function buildPDF() {
        if (!window.jspdf || !window.jspdf.jsPDF)
          throw new Error("jsPDF not loaded");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });
        const W = doc.internal.pageSize.getWidth();
        const H = doc.internal.pageSize.getHeight();
        const M = 36;
        let y = M;

        const form = JSON.parse(localStorage.getItem(LS_KEYS.form) || "{}");
        const items = readEntries();

        function drawHeader() {
          y = M;
          // Tajuk
          doc.setFont("helvetica", "bold");
          doc.setFontSize(16);
          doc.text("LAPORAN  LAWATAN  TAPAK", W / 2, y, { align: "center" });
          y += 16;
          doc.setFont("helvetica", "normal");
          doc.setFontSize(10);
          doc.text(`Dijana: ${new Date().toLocaleString()}`, W / 2, y, {
            align: "center",
          });
          y += 14;

          // Jadual Maklumat Asas
          doc.setFont("helvetica", "normal");
          doc.setFontSize(10);
          const info = [
            [`Nama Projek:`, form.namaProjek || "-"],
            [`Perkara:`, form.perkara || "-"],
            [`Tarikh:`, form.tarikh || "-"],
            [`Nama Bangunan:`, form.namaBangunan || "-"],
            [`Email:`, form.email || "-"],
          ];

          info.forEach(([label, value]) => {
            doc.setFont("helvetica", "bold");
            doc.text(label, M, y);
            doc.setFont("helvetica", "normal");
            doc.text(value, M + 80, y);
            y += 12;
          });

          // Separator line
          y += 5;
          doc.setDrawColor(100);
          doc.setLineWidth(0.5);
          doc.line(M, y, W - M, y);
          y += 15;
        }

        async function drawItem(it, idx) {
          const images = it.images || (it.img ? [it.img] : []);
          const minNeeded = 280 + (images.length > 1 ? 100 * Math.ceil(images.length / 2) : 0);
          
          if (y + minNeeded > H - M) {
            doc.addPage();
            drawHeader();
          }

          const leftW = (W - M * 2) * 0.45;
          const rightW = (W - M * 2) * 0.55;
          const rightX = M + leftW + 10;
          const itemH = Math.max(200, images.length > 2 ? 300 : 200);

          // Item header
          doc.setFont("helvetica", "bold");
          doc.setFontSize(11);
          doc.text(`${idx + 1}. Lokasi: ${it.lokasi || "Bilik TCR"}`, M, y);
          y += 15;

          // Create boxes
          doc.setDrawColor(0);
          doc.setLineWidth(0.8);
          doc.rect(M, y, leftW, itemH);
          doc.rect(rightX, y, rightW, itemH);

          // Add images
          if (images.length > 0) {
            try {
              const imagesPerRow = 2;
              const imgW = (leftW - 20) / imagesPerRow;
              const imgH = Math.min(imgW * 0.75, (itemH - 20) / Math.ceil(images.length / imagesPerRow));

              for (let i = 0; i < images.length && i < 6; i++) { // Max 6 images
                const row = Math.floor(i / imagesPerRow);
                const col = i % imagesPerRow;
                const imgX = M + 10 + col * imgW;
                const imgY = y + 10 + row * (imgH + 5);

                await new Promise((resolve) => {
                  const img = new Image();
                  img.onload = () => {
                    try {
                      doc.addImage(
                        images[i],
                        "JPEG",
                        imgX,
                        imgY,
                        imgW - 5,
                        imgH,
                        undefined,
                        "FAST"
                      );
                    } catch (e) {
                      console.warn("Failed to add image:", e);
                    }
                    resolve();
                  };
                  img.onerror = resolve;
                  img.src = images[i];
                });
              }

              if (images.length > 6) {
                doc.setFont("helvetica", "italic");
                doc.setFontSize(8);
                doc.text(
                  `+${images.length - 6} lagi gambar`,
                  M + leftW / 2,
                  y + itemH - 10,
                  { align: "center" }
                );
              }
            } catch (e) {
              doc.setFont("helvetica", "italic");
              doc.setFontSize(10);
              doc.text(
                "(gambar tidak dapat dimuatkan)",
                M + leftW / 2,
                y + itemH / 2,
                { align: "center" }
              );
            }
          } else {
            doc.setFont("helvetica", "italic");
            doc.setFontSize(10);
            doc.text("(tiada gambar)", M + leftW / 2, y + itemH / 2, {
              align: "center",
            });
          }

          // Add comments header
          doc.setFont("helvetica", "bold");
          doc.setFontSize(10);
          doc.text("Ulasan:", rightX + 8, y + 15);

          // Add comments content
          doc.setFont("helvetica", "normal");
          doc.setFontSize(10);
          if (it.ulasan) {
            const bullets = it.ulasan
              .split(/\n+/)
              .filter((line) => line.trim())
              .map((s) => "‚Ä¢ " + s.replace(/^‚Ä¢\s*/, ""));
            const wrapped = doc.splitTextToSize(
              bullets.join("\n"),
              rightW - 16
            );
            doc.text(wrapped, rightX + 8, y + 30);
          } else {
            doc.setFont("helvetica", "italic");
            doc.text("(tiada ulasan)", rightX + 8, y + 30);
          }

          y += itemH + 15;
        }

        // Header mula
        drawHeader();
        for (let i = 0; i < items.length; i++) {
          await drawItem(items[i], i);
        }

        return doc;
      }

      async function shareOrPrint() {
        const form = JSON.parse(localStorage.getItem(LS_KEYS.form) || "{}");
        const fname = `LaporanTapak_${(form.namaProjek || "projek").replace(
          /\s+/g,
          "_"
        )}_${todayISO()}.pdf`;
        try {
          if (window.jspdf && window.jspdf.jsPDF) {
            showToast("Menjana PDF...");
            const doc = await buildPDF();
            const blob = doc.output("blob");
            const file = new File([blob], fname, { type: "application/pdf" });
            if (
              navigator.share &&
              navigator.canShare &&
              navigator.canShare({ files: [file] })
            ) {
              await navigator.share({
                title: "Laporan Tapak",
                text: `Laporan: ${form.namaProjek || ""}`,
                files: [file],
              });
              return;
            }
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fname;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            return;
          }
        } catch (e) {
          console.warn(e);
          showToast("Gagal jana PDF, cuba cetak HTML");
        }
        openPrintView(); // fallback HTML print
      }

      // Submit sahaja di Section 4
      $("btnSubmit").addEventListener("click", async () => {
        const required = ["namaProjek", "perkara", "tarikh", "email"];
        for (const k of required) {
          if (!formEls[k].value.trim()) {
            alert("Sila lengkapkan semua medan wajib di Bahagian 1.");
            formEls[k].focus();
            return;
          }
        }

        const items = readEntries();
        if (items.length === 0) {
          alert(
            "Sila tambah sekurang-kurangnya satu item lokasi di Bahagian 2."
          );
          return;
        }

        const submitBtn = $("btnSubmit");
        submitBtn.disabled = true;
        submitBtn.textContent = "Memproses...";
        submitBtn.classList.add("loading");

        try {
          await shareOrPrint();
          
          // Clean data after successful submission
          localStorage.removeItem(LS_KEYS.entries);
          localStorage.removeItem(LS_KEYS.form);
          refreshTable();
          
          ["lokasi", "ulasan"].forEach((id) => ($(id).value = ""));
          state.images = [];
          updateImagePreview();
          $("fileCamera").value = "";
          $("fileGallery").value = "";
          Object.values(formEls).forEach((el) => (el.value = ""));
          
          showToast("Selesai! Data telah dibersihkan.");
        } catch (e) {
          console.error(e);
          showToast("Ralat semasa memproses. Cuba lagi.");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Simpan & Hantar";
          submitBtn.classList.remove("loading");
        }
      });

      // ===== Enhanced HTML print fallback for multiple images
      function openPrintView() {
        const form = JSON.parse(localStorage.getItem(LS_KEYS.form) || "{}");
        const items = readEntries();
        const win = window.open("", "_blank");
        const esc = (s) =>
          String(s || "").replace(
            /[&<>]/g,
            (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c])
          );

        const headerBlock = `
          <h1>LAPORAN LAWATAN TAPAK</h1>
          <div class="sub">Dijana: ${new Date().toLocaleString()}</div>
          <table style="width:100%; margin-bottom:20px">
            <tr><td><strong>Nama Projek:</strong></td><td>${esc(form.namaProjek)}</td></tr>
            <tr><td><strong>Perkara:</strong></td><td>${esc(form.perkara)}</td></tr>
            <tr><td><strong>Tarikh:</strong></td><td>${esc(form.tarikh)}</td></tr>
            <tr><td><strong>Nama Bangunan:</strong></td><td>${esc(form.namaBangunan)}</td></tr>
            <tr><td><strong>Email:</strong></td><td>${esc(form.email)}</td></tr>
          </table>
          <hr>
        `;

        let html = `<!doctype html><html><head><meta charset="utf-8"><title>Laporan (Cetak)</title>
        <style>
          body{font-family:Inter,Arial,sans-serif;margin:14mm}
          h1{font-size:16pt;margin:0 0 4pt;text-align:center}
          .sub{font-size:9pt;text-align:center;margin:0 0 8pt}
          table{border-collapse:collapse;width:100%;font-size:10pt}
          th,td{border:1px solid #aaa;padding:6pt;vertical-align:top}
          .page-break{page-break-before:always}
          .gallery img{max-width:100%;max-height:120pt;object-fit:contain;margin:2pt;border-radius:4pt;}
          .image-grid{display:flex;flex-wrap:wrap;gap:4pt;}
          @page{size:A4;margin:14mm}
        </style></head><body>${headerBlock}`;

        if (items.length === 0) {
          html += "<p>(Tiada item)</p>";
        } else {
          items.forEach((it, idx) => {
            if (idx > 0) html += '<div class="page-break"></div>' + headerBlock;
            
            const images = it.images || (it.img ? [it.img] : []);
            let imageHtml = "";
            
            if (images.length > 0) {
              imageHtml = '<div class="image-grid">';
              images.forEach(imgSrc => {
                imageHtml += `<img src="${imgSrc}" style="max-width:120pt;max-height:80pt;">`;
              });
              imageHtml += '</div>';
            } else {
              imageHtml = "(tiada gambar)";
            }
            
            html += `
              <table style="margin-top:8pt">
                <tr><th style="width:50%">No: ${idx + 1} &nbsp;&nbsp; Lokasi: ${esc(it.lokasi || "-")}</th><th>Ulasan</th></tr>
                <tr>
                  <td class="gallery">${imageHtml}</td>
                  <td><ul>${esc(it.ulasan || "")
                    .split(/\n+/)
                    .filter(t => t.trim())
                    .map((t) => `<li>${t.replace(/^‚Ä¢\s*/, "")}</li>`)
                    .join("")}</ul></td>
                </tr>
              </table>
            `;
          });
        }
        
        html += "</body></html>";
        win.document.open();
        win.document.write(html);
        win.document.close();

        // Wait for images to load before printing
        let imagesLoaded = 0;
        const totalImages = win.document.images.length;
        
        if (totalImages === 0) {
          setTimeout(() => {
            win.focus();
            win.print();
          }, 500);
          return;
        }

        Array.from(win.document.images).forEach(img => {
          if (img.complete) {
            imagesLoaded++;
          } else {
            img.onload = img.onerror = () => {
              imagesLoaded++;
              if (imagesLoaded === totalImages) {
                win.focus();
                win.print();
              }
            };
          }
        });

        if (imagesLoaded === totalImages) {
          setTimeout(() => {
            win.focus();
            win.print();
          }, 500);
        }
      }

      // ===== iOS-specific viewport and keyboard handling
      function setupIOSHandling() {
        // Prevent zoom on input focus
        const inputs = document.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
          input.addEventListener('focus', function() {
            document.querySelector('meta[name="viewport"]').setAttribute(
              'content', 
              'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'
            );
          });
          
          input.addEventListener('blur', function() {
            document.querySelector('meta[name="viewport"]').setAttribute(
              'content', 
              'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'
            );
          });
        });

        // Handle visual viewport changes for iOS keyboard
        if (window.visualViewport) {
          const handleViewportChange = () => {
            const vv = window.visualViewport;
            const keyboardHeight = Math.max(0, window.innerHeight - vv.height);
            
            document.body.style.paddingBottom = keyboardHeight > 100 ? `${keyboardHeight + 20}px` : '20px';
            
            // Scroll active input into view
            const activeElement = document.activeElement;
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
              setTimeout(() => {
                activeElement.scrollIntoView({ 
                  behavior: 'smooth', 
                  block: 'center',
                  inline: 'nearest'
                });
              }, 300);
            }
          };

          visualViewport.addEventListener('resize', handleViewportChange);
          visualViewport.addEventListener('scroll', handleViewportChange);
        }

        // Prevent rubber band scrolling on iOS
        let startY = 0;
        document.addEventListener('touchstart', function(e) {
          startY = e.touches[0].pageY;
        }, { passive: true });

        document.addEventListener('touchmove', function(e) {
          const currentY = e.touches[0].pageY;
          const isAtTop = window.scrollY <= 0;
          const isAtBottom = window.scrollY >= document.body.scrollHeight - window.innerHeight;
          
          if ((isAtTop && currentY > startY) || (isAtBottom && currentY < startY)) {
            e.preventDefault();
          }
        }, { passive: false });
      }

      // ===== Initialization
      document.addEventListener('DOMContentLoaded', () => {
        loadForm();
        refreshTable();
        setupIOSHandling();
        
        // Set today's date if not set
        if (!formEls.tarikh.value) {
          formEls.tarikh.value = todayISO();
        }
        
        // Focus first empty required field
        const firstEmptyRequired = Object.values(formEls).find(el => el.required && !el.value.trim());
        if (firstEmptyRequired) {
          setTimeout(() => firstEmptyRequired.focus(), 500);
        }
      });

      // Initialize immediately for better UX
      loadForm();
      refreshTable();
      setupIOSHandling();
    </script>
  </body>
</html>
